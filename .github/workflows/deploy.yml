name: Smart FTP Deploy
on:
  push:
    branches: [ master ]

jobs:
  deploy:
    name: ğŸš€ Deploy Changes
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 # Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ú©Ø§Ù…ÛŒØª Ù‚Ø¨Ù„ÛŒ Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒÙ…
      
      - name: ğŸ” Get changed files
        id: changed-files
        run: |
          # Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ùˆ Ø¬Ø¯ÛŒØ¯
          echo "modified=$(git diff --name-only --diff-filter=M HEAD^1 HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT
          echo "added=$(git diff --name-only --diff-filter=A HEAD^1 HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT
          
          # Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯
          git diff --name-only --diff-filter=M HEAD^1 HEAD > modified_files.txt
          git diff --name-only --diff-filter=A HEAD^1 HEAD > added_files.txt
      
      - name: ğŸ“¤ Upload changed files
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          # Ù†ØµØ¨ lftp Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
          sudo apt-get install -y lftp
          
          # ØªÙ†Ø¸ÛŒÙ… Ø§Ø³Ú©Ø±ÛŒÙ¾Øª LFTP
          echo "set ssl:verify-certificate no
          set ftp:ssl-allow no
          open ftp://$FTP_USERNAME:$FTP_PASSWORD@$FTP_SERVER
          
          # Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡
          cat modified_files.txt | while read file; do
            if [ ! -z "\$file" ]; then
              echo "Updating \$file"
              put -O public_html/\$(dirname \$file) \$file
            fi
          done
          
          # Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
          cat added_files.txt | while read file; do
            if [ ! -z "\$file" ]; then
              echo "Adding new file \$file"
              mkdir -p -f public_html/\$(dirname \$file)
              put -O public_html/\$(dirname \$file) \$file
            fi
          done
          
          bye" > upload_script.lftp
          
          # Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¢Ù¾Ù„ÙˆØ¯
          lftp -f upload_script.lftp
          
      - name: ğŸ“ Report changes
        if: always()
        run: |
          echo "Modified files: ${{ steps.changed-files.outputs.modified }}"
          echo "Added files: ${{ steps.changed-files.outputs.added }}"
