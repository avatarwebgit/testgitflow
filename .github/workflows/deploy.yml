name: Smart FTP Deploy
on:
  push:
    branches: [ master ]

jobs:
  deploy:
    name: 🚀 Deploy Changes
    runs-on: ubuntu-latest
    
    steps:
      - name: 📂 Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 # برای مقایسه با کامیت قبلی نیاز داریم
      
      - name: 🔍 Get changed files
        id: changed-files
        run: |
          # لیست فایل‌های تغییر کرده و جدید
          echo "modified=$(git diff --name-only --diff-filter=M HEAD^1 HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT
          echo "added=$(git diff --name-only --diff-filter=A HEAD^1 HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT
          
          # ذخیره لیست فایل‌ها در فایل برای استفاده در مرحله بعد
          git diff --name-only --diff-filter=M HEAD^1 HEAD > modified_files.txt
          git diff --name-only --diff-filter=A HEAD^1 HEAD > added_files.txt
      
      - name: 📤 Upload changed files
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          # نصب lftp برای آپلود فایل‌ها
          sudo apt-get install -y lftp
          
          # تنظیم اسکریپت LFTP
          echo "set ssl:verify-certificate no
          set ftp:ssl-allow no
          open ftp://$FTP_USERNAME:$FTP_PASSWORD@$FTP_SERVER
          
          # آپلود فایل‌های تغییر یافته
          cat modified_files.txt | while read file; do
            if [ ! -z "\$file" ]; then
              echo "Updating \$file"
              put -O public_html/\$(dirname \$file) \$file
            fi
          done
          
          # آپلود فایل‌های جدید
          cat added_files.txt | while read file; do
            if [ ! -z "\$file" ]; then
              echo "Adding new file \$file"
              mkdir -p -f public_html/\$(dirname \$file)
              put -O public_html/\$(dirname \$file) \$file
            fi
          done
          
          bye" > upload_script.lftp
          
          # اجرای اسکریپت آپلود
          lftp -f upload_script.lftp
          
      - name: 📝 Report changes
        if: always()
        run: |
          echo "Modified files: ${{ steps.changed-files.outputs.modified }}"
          echo "Added files: ${{ steps.changed-files.outputs.added }}"
